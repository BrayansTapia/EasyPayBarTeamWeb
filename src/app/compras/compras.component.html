<app-nav-proveedor></app-nav-proveedor>

<div class="component-container">
  <div class="page-head">
    <i class="fa fa-chevron-left fa-3x" id="return" aria-hidden="true" [routerLink]="['/menu-proveedor']"></i>
    <h1 class="page-title">Registro compra</h1>
  </div>
  <div class="page-main">
    <div class="page-section">
      <div class="panel panel-primary">
        <div class="panel-heading">
          <h3 class="panel-title"><b>Datos de la categoría y el cliente afiliado</b></h3>
        </div>
        <div class="color-panel-body panel-body">
          <div class="row">
            <div class="col-sm-5">
              <label class="col-lg-4 control-label"><h4><b><span style="color:#fff;">Categoría:</span></b></h4></label>
              <div class="input-group search-bar" style="width: 40%; margin-left: 20px;">
                <input mdInput type="text" class="form-control" placeholder="Ingrese la categoría" [mdAutocomplete]="autoCategoria" [formControl]="categoriaCtrl" [value]="categoria.nombre" [(ngModel)]="categoria.nombre">
                <span class="input-group-btn">
                  <button class="btn btn-primary" (click)="buscarCategoria()"><i class="fa fa-search" aria-hidden="true"></i></button>
                </span>
              </div>
  
              <md-autocomplete #autoCategoria="mdAutocomplete">
                <md-option *ngFor="let cat of categoriasFiltradas | async" [value]="cat.nombre">
                  {{ cat.nombre }}   
                </md-option>
              </md-autocomplete>
            </div>

            <div class="col-sm-5">
              <label class="col-lg-4 control-label"><h4><b><span style="color:#fff;">Cliente:</span></b></h4></label>
              <div class="input-group search-bar" style="width: 40%; margin-left: 20px;">
                <input type="text" class="form-control" placeholder="Ingrese el cliente" [value]="afiliado.nombre" [(ngModel)]="afiliado.nombre" disabled>
                <span class="input-group-btn">
                  <div *ngIf="afiliado.nombre == ''">
                    <button class="btn btn-primary" (click)="modalClienteQR.open()"><i class="fa fa-search" aria-hidden="true"></i></button>
                  </div>
                  <div *ngIf="afiliado.nombre != ''">
                    <button class="btn btn-primary" disabled><i class="fa fa-search" aria-hidden="true"></i></button>
                  </div>
                </span>
              </div>
            </div>

            <div class="col-sm-2">
              <label class="col-lg-4 control-label"><h4><b><span style="color:#fff;">Saldo:</span></b></h4></label>
              <div class="col-lg-5">
                <h4><b><span style="color:#fff;">${{ afiliado.saldo }}</span></b></h4>
              </div>
            </div>

          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-sm-6">
          <h3><span style="color:#fff;"><b>Listado de productos</b></span></h3>
          <table class="table table-hovered">
            <thead>
              <tr>
                <th>Imagen</th>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Agregar</th>
            </thead>  
            <tbody>
              <tr *ngFor="let produc of productos | async | paginate: { itemsPerPage: 5, currentPage: p }">
                <td>
                  <img src="{{ produc.imagenURL }}" class="img-responsive" height="50" width="50" alt="Producto">
                </td>
                <td>{{ produc.nombre }}</td>
                <td>${{ produc.precio }}</td>
                <td>
                  <button md-mini-fab class="mat-fab" (click)="abrirModalAgregarProducto(produc.$key, produc.nombre, produc.precio)"><i class="fa fa-plus" aria-hidden="true"></i></button>
                </td>
              </tr>
            </tbody>
          </table>
          <!-- Pagination -->
          <pagination-controls (pageChange)="p = $event"></pagination-controls>
        </div>

        <div class="col-sm-6">
          <div *ngIf="afiliado.nombre == '' || afiliado.saldo == 0">
            <h3><span style="color:#fff;"><b>Detalle de compra</b></span></h3>
          </div>
          <div *ngIf="afiliado.nombre !== '' && afiliado.saldo !== 0">
            <h3><span style="color:#fff;"><b>Detalle de compra del cliente: {{ afiliado.nombre }}</b></span></h3>
          </div>
          <table class="table table-hovered">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Editar</th>
                <th>Eliminar</th>
            </thead>  
            <tbody>
              <tr *ngFor="let producDet of listaProductosDetalle">
                <td>{{ producDet.producto }}</td>
                <td>${{ producDet.precio }}</td>
                <td>{{ producDet.cantidad }}</td>
                <td>
                  <button class="btn btn-xs btn-success" (click)="abrirModalEditarDetalle(producDet.key, producDet.producto, producDet.precio, producDet.cantidad)"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></button>
                </td>
                <td>
                  <button class="btn btn-xs btn-danger" (click)="abrirModalEliminarDetalle(producDet.key, producDet.producto, producDet.precio, producDet.cantidad)"><i class="fa fa-trash-o" aria-hidden="true"></i></button>
                </td>
              </tr>
              <tr><td class="colot-tr-table">Total:</td><td class="colot-tr-table"></td><td class="colot-tr-table"></td><td class="colot-tr-table"></td><td class="colot-tr-table">${{ compra.total | number : '1.2-2' }}</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <span class="app-action-md-fab"><button md-fab class="mat-fab" (click)="realizarCompra()"><i class="fa fa-shopping-cart" aria-hidden="true"></i></button></span>
  </div>
</div>

<modal #modalAgregarProducto>
  <modal-header>
    <h4 class="modal-title">Agregando producto al detalle de compra</h4>
  </modal-header>

  <modal-body class="form-horizontal">
    <div class="form-group">
      <label class="col-lg-2 control-label"><h5><b>Cantidad:</b></h5></label>
      <div class="col-lg-9">
        <input type="number" class="form-control" name="txtcantidad" placeholder="Ingrese la cantidad" [(ngModel)]="detalleCompra.cantidad" #cantidad="ngModel" required [min]="1" [max]="10"/>
        <span style="color:#e74c3c;" *ngIf="cantidad.errors?.required"><p>La cantidad es requerida.</p></span>
      </div>
    </div>
  </modal-body>

  <modal-footer>
    <div *ngIf="cantidad.errors">
      <button type="button" class="btn btn-primary col-lg-5" disabled><i class="fa fa-check" aria-hidden="true"></i> Confirmar</button>
    </div>
    <div *ngIf="!cantidad.errors">
      <button type="button" class="btn btn-primary col-lg-5" data-dismiss="modal" (click)="agregarProductoDetalle()"><i class="fa fa-check" aria-hidden="true"></i> Confirmar</button>
    </div>
    <button type="button" style="width: 40%" class="btn btn-danger col-lg-5" (click)="modalAgregarProducto.close()"><span class="glyphicon glyphicon-remove"></span> Confirmar</button>
  </modal-footer>
</modal>

<modal #modalEliminarProducto>
  <modal-header>
    <h4 class="modal-title">¿Desea eliminar este producto del detalle de compra?</h4>
  </modal-header>

  <modal-body>
    <div class="form-group">
      <h5><b>Nombre:</b> {{ producto.nombre }}</h5>
    </div>

    <div class="form-group">
      <h5><b>Precio:</b> ${{ producto.precio }}</h5>
    </div>

    <div class="form-group">
      <h5><b>Cantidad:</b> {{ detalleCompra.cantidad }}</h5>
    </div>
  </modal-body>

  <modal-footer>
    <button type="button" class="btn btn-primary col-lg-5" data-dismiss="modal" (click)="eliminarProductoDetalle()"><i class="fa fa-check" aria-hidden="true"></i> Confirmar</button>
    <button type="button" class="btn btn-danger col-lg-5" style="margin-left: 0px" (click)="modalEliminarProducto.close()"><i class="fa fa-times" aria-hidden="true"></i> Cancelar</button>
  </modal-footer>
</modal>

<modal #modalEditarProducto>
  <modal-header>
    <h4 class="modal-title">¿Desea editar este producto del detalle de compra?</h4>
  </modal-header>

  <modal-body class="form-horizontal">
    <div class="form-group">
      <label class="col-lg-2 control-label"><h5><b>Cantidad:</b></h5></label>
      <div class="col-lg-9">
        <input type="number" class="form-control" name="txtcantidad" placeholder="Ingrese la cantidad" [(ngModel)]="detalleCompra.cantidad" #cantidad="ngModel" [value]="detalleCompra.cantidad" required [min]="1" [max]="10" />
        <span style="color:#e74c3c;" *ngIf="cantidad.errors?.required"><p>La cantidad es requerida.</p></span>
      </div>
    </div>
  </modal-body>

  <modal-footer>
    <div *ngIf="cantidad.errors">
      <button type="button" class="btn btn-primary col-lg-5" disabled><i class="fa fa-check" aria-hidden="true"></i> Confirmar</button>
    </div>
    <div *ngIf="!cantidad.errors">
      <button type="button" class="btn btn-primary col-lg-5" data-dismiss="modal" (click)="actualizarProductoDetalle()"><i class="fa fa-check" aria-hidden="true"></i> Confirmar</button>
    </div>
    <button type="button" style="width: 40%" class="btn btn-danger col-lg-5" (click)="modalEditarProducto.close()"><span class="glyphicon glyphicon-remove"></span> Confirmar</button>
  </modal-footer>
</modal>

<modal #modalProductoExistente>
  <modal-header>
    <h4 class="modal-title">Mensaje</h4>        
  </modal-header>

  <modal-body>
    <div class="form-group">
      <h5>Este producto ya ha sido agregado al detalle de venta.</h5>
    </div>    
  </modal-body>

  <modal-footer style="text-align: center;">
    <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fa fa-times" aria-hidden="true"></i> Cerrar</button>
  </modal-footer>
</modal>

<modal #modalSaldoInsuficiente>
  <modal-header>
    <h4 class="modal-title">Mensaje</h4>        
  </modal-header>

  <modal-body>
    <div class="form-group">
      <h5>Este clientes no tiene el suficiente saldo para realizar esta compra.</h5>
    </div>    
  </modal-body>

  <modal-footer style="text-align: center;">
    <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fa fa-times" aria-hidden="true"></i> Cerrar</button>
  </modal-footer>
</modal>

<modal #modalCompraExitosa>
  <modal-header>
    <h4 class="modal-title">Mensaje</h4>        
  </modal-header>

  <modal-body>
    <div class="form-group">
      <h5>Compra realizada correctamente.</h5>
    </div>    
  </modal-body>

  <modal-footer style="text-align: center;">
    <button type="button" class="btn btn-primary" data-dismiss="modal"><i class="fa fa-check-square" aria-hidden="true"></i> Aceptar</button>
  </modal-footer>
</modal>

<modal #modalVerificarCompra>
  <modal-header>
    <h4 class="modal-title">Mensaje</h4>        
  </modal-header>

  <modal-body>
    <div class="form-group">
      <h5>Debe llenar todos los datos para realizar la compra.</h5>
    </div>    
  </modal-body>

  <modal-footer style="text-align: center;">
    <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fa fa-times" aria-hidden="true"></i> Cerrar</button>
  </modal-footer>
</modal>

<modal #modalClienteQR>
  <modal-header>
    <h4 class="modal-title">Buscar cliente por su codigo QR.</h4>        
  </modal-header>

  <modal-body>
    <div class="form-group">
      <h5>Muestre el codigo QR a la camara</h5>
      <qr-scanner
        [debug]="false"        
        [canvasWidth]="300"    
        [canvasHeight]="300"   
        [mirror]="false"       
        [stopAfterScan]="true" 
        [updateTime]="500"     
        (onRead)="leerCodigoQRCliente($event)">
      </qr-scanner>
    </div>    
  </modal-body>

  <modal-footer style="text-align: center;">
    <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fa fa-times" aria-hidden="true"></i> Cerrar</button>
  </modal-footer>
</modal>